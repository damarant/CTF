
#laboratorio #tryhackmelabs 

https://tryhackme.com/room/pwnkit

CVE -2021-4034 (conosciuta colloquialmente come "Pwnkit") è una terrificante vulnerabilità **di** scalabilità **dei** **privilegi** locali (LPE), localizzata nel pacchetto "Polkit", installato di default su quasi tutte le principali distribuzioni del sistema operativo Linux (così come su molti altri sistemi operativi *nix). In altre parole, colpisce praticamente tutti i sistemi Linux più diffusi al mondo.  

Questa sala fornirà una panoramica della vulnerabilità e consigli su come applicare patch ai sistemi interessati. È stata inoltre allegata una macchina vulnerabile per consentirvi di testare la vulnerabilità in prima persona!

Senza ulteriori indugi, cominciamo.

**Panoramica**

La vulnerabilità CVE -2021-4034 (nota anche come "pwnkit") è stata scoperta dai ricercatori di [Qualys](https://www.qualys.com/) e annunciata a gennaio 2022; l'avviso di sicurezza tecnico per questa vulnerabilità è disponibile [qui](https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt) . La vulnerabilità è presente in ogni versione del pacchetto "Policy Toolkit" (o Polkit) sin dal suo primo rilascio nel 2009 e consente a qualsiasi aggressore senza privilegi di ottenere facilmente il pieno accesso amministrativo su qualsiasi macchina Linux con il pacchetto Polkit installato. Sfortunatamente, Polkit è installato di default sulla maggior parte delle distribuzioni Linux , il che rende questa vulnerabilità _estremamente_ diffusa.

La facilità di sfruttamento e la natura ubiquitaria di Polkit rendono questa vulnerabilità assolutamente devastante; fortunatamente, tuttavia, non è sfruttabile da remoto, rendendo **Pwnkit puramente una vulnerabilità di escalation dei privilegi locali (LPE).**

**Che cos'è Polkit?**  

Prima di esaminare direttamente la vulnerabilità, è utile capire cos'è effettivamente Polkit.  

Polkit fa parte del sistema di autorizzazione di Linux . Infatti, quando si tenta di eseguire un'azione che richiede privilegi più elevati, Polkit può essere utilizzato per determinare se si possiedono i permessi necessari. È integrato con systemd ed è molto più configurabile del tradizionale sistema sudo. Infatti, a volte viene definito il "sudo di systemd", in quanto fornisce un sistema granulare per l'assegnazione dei permessi agli utenti.

Quando interagiamo con polkit, possiamo usare l' `pkexec`utilità: **è questo programma a contenere la vulnerabilità Pwnkit**. Come esempio di utilizzo dell'utilità, il tentativo di eseguire il `useradd`comando `pkexec`in una sessione GUI genera un pop-up che richiede le credenziali:  
`pkexec useradd test1234`

In una sessione CLI , invece, otteniamo un prompt basato su testo:  

**pkexec quando eseguito dalla riga di comando**

```shell-session
muiri@demo-vm:~$ pkexec useradd test1234
==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===
Authentication is needed to run '/usr/sbin/useradd' as the super user
Authenticating as: muiri,,, (muiri)
Password:
```

Riassumendo, il policy toolkit può essere considerato un'alternativa più dettagliata al più semplice sistema sudo con cui potresti già avere familiarità.

**La vulnerabilità**

Come accennato in precedenza, la vulnerabilità Pwnkit è presente nell'utility `pkexec`, il principale front-end del sistema Polkit. Per questioni di leggibilità, non entreremo _troppo_ nei dettagli; tuttavia, vi invitiamo a leggere l' [avviso di sicurezza di Qualys](https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt) per una spiegazione tecnica completa della vulnerabilità.

In breve, le versioni di pkexec rilasciate prima della patch non gestiscono in modo sicuro gli argomenti della riga di comando, il che porta a una vulnerabilità di "scrittura fuori limite", che consente a un aggressore di manipolare l'ambiente in cui viene eseguito pkexec. Questo è tutto ciò che _serve_ sapere, ma per una spiegazione leggermente più tecnica, continua a leggere!  

Più specificamente, pkexec tenta di analizzare tutti gli argomenti della riga di comando che gli passiamo usando un ciclo for, partendo da un indice pari a 1 per compensare il nome del programma e ottenere il primo argomento reale (ad esempio, se inserissimo `pkexec bash`, allora come  `pkexec` è il nome del programma, sarebbe argomento 0 — gli argomenti effettivi della riga di comando iniziano dall'indice 1). Il nome del programma è irrilevante per l'analisi degli argomenti, quindi l'indicizzazione viene semplicemente compensata per ignorarlo.

Cosa succede, quindi, se non forniamo argomenti? L'indice viene impostato _permanentemente_ a 1!

Il seguente pseudocodice può aiutarti a visualizzarlo:

Pseudocodice: indicizzazione degli elenchi a partire da 1

```shell-session
for(n=1; n < number_of_arguments; n++){
  //Do Stuff
}
```

Se il numero di argomenti è 0, allora − non `n`è _mai_ inferiore al numero di argomenti. Pertanto, `n`rimane uguale a uno e il ciclo viene completamente ignorato.

Questo diventa un problema in seguito, quando pkexec tenta di scrivere sul valore dell'argomento all'indice `n`. Poiché non ci sono argomenti da riga di comando, non c'è _alcun_ argomento all'indice `n`; invece, il programma sovrascrive il valore successivo in memoria, che per puro caso è il primo valore nell'elenco delle variabili d'ambiente quando il programma viene chiamato tramite una funzione C chiamata `execve()`. **In altre parole, passando a pkexec un elenco nullo di argomenti, possiamo forzarlo a sovrascrivere una variabile d'ambiente!**  

Per contestualizzare: alcune variabili d'ambiente "pericolose" vengono rimosse dal sistema operativo quando si tenta di eseguire un programma con il [bit SUID](https://muirlandoracle.co.uk/2020/03/05/unix-file-permissions/#SUID) impostato (come fa pkexec per necessità); questo per impedire agli aggressori di dirottare il programma mentre viene eseguito con permessi amministrativi. Utilizzando la scrittura fuori limite, siamo in grado di reintrodurre la nostra scelta di queste variabili d'ambiente pericolose, inducendo pkexec ad aggiungerle per noi. Esistono diversi modi per abusare di questa funzionalità, tutti con conseguente esecuzione di codice come utente root.  

Rispondi alle domande seguenti

Pwnkit è sfruttabile da remoto (Sì/No)?  

```
nay
```

In quale utility Polkit risiede la vulnerabilità Pwnkit?
```
pkexec
```

**Exploitation**
Purtroppo, sfruttare Pwnkit è incredibilmente facile.

Sono disponibili online molti exploit e scriverne una propria versione non è particolarmente difficile.

La versione che utilizzeremo è scritta in C da arthepsy ed è stata rilasciata subito dopo la pubblicazione dell'avviso di sicurezza di Qualys. Il repository è disponibile [qui](https://github.com/arthepsy/CVE-2021-4034) . Questa variante dell'exploit sfrutta la `GCONV_PATH`variabile "pericolosa" per includere un file di oggetto condiviso dannoso che richiama la `/bin/sh`shell con permessi di root.  

---

Per prima cosa, dobbiamo connetterci al computer di destinazione. Se utilizzi la connessione in-browser, avrai già accesso tramite il browser, utilizzando il terminale sul lato destro dello schermo.

Se **non** utilizzi la connessione nel browser, puoi connetterti tramite SSH e queste credenziali:

- Nome utente:`tryhackme`  
    
- Password:  `TryHackMe123!`  
    

Una volta connessi, dobbiamo andare alla `pwnkit/`sottodirectory pre-aggiunta, quindi compilare l'exploit utilizzando il seguente comando:

```
cd pwnkit
```

```
gcc cve-2021-4034-poc.c -o exploit
```

Possiamo quindi eseguire l'exploit `./exploit`per ottenere immediatamente l'accesso root sul target!  
```
./exploit
```
L'intero processo può essere visto nel filmato qui sotto:

Rispondi alle domande seguenti

Leggi attentamente il `cve-2021-4034-poc.c`file e cerca di capirne il funzionamento. Verifica se riesci a confrontarlo con l' [avviso di sicurezza di Qualys](https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt) e con la spiegazione fornita nell'esercizio precedente!  

Sfrutta la vulnerabilità!  

Dove si trova la bandiera `/root/flag.txt`?  

```
cat /root/flag.txt
```

```
THM{CONGRATULATIONS-YOU-EXPLOITED-PWNKIT}
```

**[Domanda bonus — facoltativa]** Utilizzando l' [avviso di Qualys](https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt) e il [repository](https://github.com/arthepsy/CVE-2021-4034) collegato nell'attività, prova a scrivere la tua versione dell'exploit Pwnkit.

**Patch**
Ora che abbiamo visto l'impatto devastante del CVE -2021-4034, come possiamo proteggerci?  

Fortunatamente, gli sviluppatori tendono a essere piuttosto rapidi nello sviluppo di patch per vulnerabilità critiche. Un esempio lampante: al momento in cui scrivo, Canonical ha già rilasciato versioni patchate del pacchetto Polkit nel gestore pacchetti APT per tutte le versioni di Ubuntu non ancora giunte al termine del ciclo di vita. La versione patchata può essere installata con un semplice aggiornamento di apt`sudo apt update && sudo apt upgrade` , ad esempio .

Nelle distribuzioni che non hanno ancora rilasciato versioni patchate del pacchetto, la soluzione consigliata è semplicemente rimuovere il bit SUID dal binario pkexec. Questo può essere fatto con un comando come il seguente:

`` sudo chmod 0755 `which pkexec` ``  

Questa è ben lontana dall'essere la soluzione ideale, tuttavia funziona come soluzione temporanea finché più distribuzioni non inizieranno a distribuire versioni di polkit con patch contro Pwnkit.

È importante notare che esistono numerose varianti dell'exploit Pwnkit, che utilizzano variabili d'ambiente diverse e sfruttano la vulnerabilità in modi diversi. Alcune di queste lasciano tracce e log, altre no.  

È possibile verificare che un sistema sia patchato provando a eseguire una copia dell'exploit. Se l'exploit restituisce il `pkexec`menu di aiuto, significa che il sistema è patchato:

Versione patchata di pkexec

```shell-session
tryhackme@pwnkit$ ./exploit
pkexec --version |
       --help |
       --disable-internal-agent |
       [--user username] PROGRAM [ARGUMENTS...]

See the pkexec manual page for more details.
```


